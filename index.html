<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Command PRO: Station Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #020617;
            --bg-panel: #0f172a;
            --bg-input: #1e293b;
            --primary: #38bdf8;
            --accent: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #64748b;
            --border: #334155;
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--text-main); }
        .logo span { color: var(--primary); }

        .dashboard {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        h3 {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* INPUTS */
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; }
        input, select {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        /* AUTOCOMPLETE */
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            margin-top: 5px;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .search-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        .search-item:hover { background: var(--bg-input); }
        .search-item .icao { font-weight: bold; color: var(--primary); margin-right: 8px; }

        /* BUTTONS */
        .btn-check {
            width: 100%; padding: 14px;
            background: linear-gradient(to right, var(--primary), var(--accent));
            color: white; border: none; border-radius: 8px;
            font-weight: 700; cursor: pointer;
            text-transform: uppercase;
        }

        /* DATA BOXES */
        .raw-metar {
            background: #000;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
            line-height: 1.4;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .metric-card.alert { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .metric-card.warn { border-color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        
        .metric-val { font-size: 1.5rem; font-weight: 700; font-family: var(--font-mono); display: block; }
        .metric-lbl { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }

        /* TOAST */
        #toast-container {
            position: fixed; bottom: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 10px; z-index: 9999;
        }
        .toast {
            background: var(--bg-panel);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            font-size: 0.9rem;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .chart-container { height: 300px; margin-top: 20px; }

        .status-banner {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 800;
            font-size: 1.2rem;
            border: 1px solid var(--border);
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">DRONE<span>COMMAND</span> PRO</div>
        <div id="dbStatus" style="font-size: 0.75rem; color: var(--text-muted);">
            <i class="fas fa-database"></i> Загрузка базы аэропортов...
        </div>
    </header>

    <div class="dashboard">
        <aside>
            <div class="panel">
                <h3><i class="fas fa-drone"></i> Настройки дрона</h3>
                <div class="form-group">
                    <label>Выберите модель</label>
                    <select id="droneSelect"></select>
                </div>
                <div id="droneLimits" style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.4;"></div>
            </div>

            <div class="panel">
                <h3><i class="fas fa-map-marked-alt"></i> Локация</h3>
                <div class="form-group">
                    <label>Поиск (Название, Город или ICAO)</label>
                    <input type="text" id="searchInput" placeholder="Напр: Sheremetyevo или UUEE">
                    <div id="searchResults" class="search-results"></div>
                </div>
                
                <div class="form-group">
                    <label>OpenWeather API Key</label>
                    <input type="password" id="apiKey" value="f3843336b2145e67e0c0614fb8585cc1">
                </div>

                <button class="btn-check" onclick="startAnalysis()">Анализировать</button>
            </div>
        </aside>

        <main>
            <div id="resultsArea" style="display: none;">
                <div id="statusBanner" class="status-banner">READY</div>

                <div class="panel">
                    <h3><i class="fas fa-broadcast-tower"></i> Raw METAR (Real-time Observation)</h3>
                    <div class="raw-metar" id="rawMetarText">---</div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card" id="cardWind">
                        <span class="metric-val" id="valWind">--</span>
                        <span class="metric-lbl">Ветер (м/с)</span>
                    </div>
                    <div class="metric-card" id="cardGust">
                        <span class="metric-val" id="valGust">--</span>
                        <span class="metric-lbl">Порывы (м/с)</span>
                    </div>
                    <div class="metric-card" id="cardTemp">
                        <span class="metric-val" id="valTemp">--</span>
                        <span class="metric-lbl">Температура</span>
                    </div>
                    <div class="metric-card" id="cardVis">
                        <span class="metric-val" id="valVis">--</span>
                        <span class="metric-lbl">Видимость</span>
                    </div>
                </div>

                <div class="panel">
                    <h3><i class="fas fa-chart-line"></i> Прогноз на 24 часа (Wind & Gusts)</h3>
                    <div class="chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="emptyState" style="text-align: center; padding-top: 100px; opacity: 0.2;">
                <i class="fas fa-satellite" style="font-size: 5rem;"></i>
                <p style="margin-top: 20px;">Ожидание выбора аэропорта...</p>
            </div>
        </main>
    </div>
</div>

<div id="toast-container"></div>

<script>
/* ================= CONFIG & DATA ================= */
const drones = [
    { name: "DJI Mini 4 Pro", wind: 10.7, gust: 13, rain: false, temp: [-10, 40] },
    { name: "DJI Mavic 3 Pro", wind: 12, gust: 15, rain: false, temp: [-10, 40] },
    { name: "DJI Matrice 30T", wind: 15, gust: 20, rain: true, temp: [-20, 50] },
    { name: "Custom FPV 5\"", wind: 18, gust: 25, rain: false, temp: [-5, 45] }
];

let airports = [];
let selectedAirport = null;
let chartInstance = null;

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded', async () => {
    initDroneSelect();
    await loadAirportsDB();
    document.getElementById('searchInput').addEventListener('input', handleSearch);
});

function initDroneSelect() {
    const sel = document.getElementById('droneSelect');
    drones.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = d.name;
        sel.appendChild(opt);
    });
    sel.addEventListener('change', updateDroneUI);
    updateDroneUI();
}

function updateDroneUI() {
    const d = drones[document.getElementById('droneSelect').value];
    document.getElementById('droneLimits').innerHTML = 
        `Ветер: до ${d.wind} м/с | Порывы: ${d.gust} м/с<br>Темп: ${d.temp[0]}°C ... ${d.temp[1]}°C | Дождь: ${d.rain ? 'Разрешен' : 'НЕТ'}`;
}

/* ================= AIRPORTS DB (CSV PARSER) ================= */
async function loadAirportsDB() {
    try {
        const response = await fetch('airports.dat');
        if (!response.ok) throw new Error("Файл airports.dat не найден");
        const text = await response.text();
        
        // Парсим CSV (учитываем запятые внутри кавычек)
        const lines = text.split('\n');
        airports = lines.map(line => {
            const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (parts.length < 8) return null;
            return {
                name: parts[1].replace(/"/g, ''),
                city: parts[2].replace(/"/g, ''),
                country: parts[3].replace(/"/g, ''),
                icao: parts[5].replace(/"/g, ''),
                lat: parseFloat(parts[6]),
                lon: parseFloat(parts[7])
            };
        }).filter(a => a && a.icao && a.icao !== '\\N');

        document.getElementById('dbStatus').innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i> База: ${airports.length} портов`;
        showToast("База данных аэропортов загружена", "success");
    } catch (err) {
        showToast(err.message, "error");
        document.getElementById('dbStatus').innerHTML = `<i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> Ошибка базы`;
    }
}

function handleSearch(e) {
    const val = e.target.value.toLowerCase();
    const resDiv = document.getElementById('searchResults');
    if (val.length < 2) { resDiv.style.display = 'none'; return; }

    const matches = airports.filter(a => 
        a.icao.toLowerCase().includes(val) || 
        a.city.toLowerCase().includes(val) || 
        a.name.toLowerCase().includes(val)
    ).slice(0, 10);

    resDiv.innerHTML = '';
    if (matches.length > 0) {
        resDiv.style.display = 'block';
        matches.forEach(a => {
            const div = document.createElement('div');
            div.className = 'search-item';
            div.innerHTML = `<span class="icao">${a.icao}</span> ${a.city}, ${a.name}`;
            div.onclick = () => {
                selectedAirport = a;
                document.getElementById('searchInput').value = `${a.icao} (${a.city})`;
                resDiv.style.display = 'none';
            };
            resDiv.appendChild(div);
        });
    } else {
        resDiv.style.display = 'none';
    }
}

/* ================= ANALYSIS CORE ================= */
async function startAnalysis() {
    if (!selectedAirport) { showToast("Выберите аэропорт из списка", "error"); return; }
    const apiKey = document.getElementById('apiKey').value;
    if (!apiKey) { showToast("Нужен API ключ OpenWeather", "error"); return; }

    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('resultsArea').style.display = 'block';

    try {
        // 1. Fetch METAR (Observations)
        const metarRaw = await fetchMetar(selectedAirport.icao);
        const metarParsed = parseMetar(metarRaw);
        
        // 2. Fetch OWM Forecast (For Chart)
        const forecast = await fetchForecast(selectedAirport.lat, selectedAirport.lon, apiKey);

        updateUI(metarParsed, forecast, metarRaw);
    } catch (err) {
        showToast(err.message, "error");
    }
}

async function fetchMetar(icao) {
    const res = await fetch(`https://metar.vatsim.net/metar.php?id=${icao}`);
    const text = await res.text();
    if (!text || text.includes("not found")) throw new Error("METAR для этого порта не найден");
    return text.trim();
}

async function fetchForecast(lat, lon, key) {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${key}`);
    const data = await res.json();
    if (data.cod !== "200") throw new Error(data.message);
    return data;
}

/* ================= METAR PARSER (PRO) ================= */
function parseMetar(metar) {
    const result = { wind: 0, gust: 0, temp: 0, vis: 9999, rain: false };

    // Wind Group: (Direction)(Speed)[G(Gust)](Units)
    // Examples: 27015G25KT, 12004MPS, VRB02KT
    const windMatch = metar.match(/(?:\s|^)(VRB|\d{3})(\d{2,3})(?:G(\d{2,3}))?(KT|MPS|KMH)/);
    if (windMatch) {
        let speed = parseInt(windMatch[2]);
        let gust = windMatch[3] ? parseInt(windMatch[3]) : speed;
        let unit = windMatch[4];

        // Конвертация в м/с
        if (unit === 'KT') { speed *= 0.514; gust *= 0.514; }
        if (unit === 'KMH') { speed *= 0.277; gust *= 0.277; }
        
        result.wind = speed;
        result.gust = gust;
    }

    // Temperature: (M?)(Digits)/(M?)(Digits)
    const tempMatch = metar.match(/(?:\s|^)(M?\d{2})\/(M?\d{2})(?:\s|$)/);
    if (tempMatch) {
        result.temp = parseInt(tempMatch[1].replace('M', '-'));
    }

    // Visibility: 9999 (meters) or 10SM (miles)
    const visMatch = metar.match(/(?:\s|^)(\d{4}|\d{1,2}SM)(?:\s|$)/);
    if (visMatch) {
        if (visMatch[1].includes('SM')) {
            result.vis = parseInt(visMatch[1]) * 1609;
        } else {
            result.vis = parseInt(visMatch[1]);
        }
    }

    // Weather Phenom (Rain, Snow, etc.)
    if (/\s(RA|SN|TS|DZ|GR|GS)\s/.test(metar)) result.rain = true;

    return result;
}

/* ================= UI UPDATER ================= */
function updateUI(metar, forecast, raw) {
    const drone = drones[document.getElementById('droneSelect').value];
    
    document.getElementById('rawMetarText').textContent = raw;
    
    // Fill Cards
    setMetric('cardWind', 'valWind', metar.wind.toFixed(1), metar.wind > drone.wind ? 'alert' : '');
    setMetric('cardGust', 'valGust', metar.gust.toFixed(1), metar.gust > drone.gust ? 'warn' : '');
    setMetric('cardTemp', 'valTemp', metar.temp + '°C', (metar.temp < drone.temp[0] || metar.temp > drone.temp[1]) ? 'alert' : '');
    setMetric('cardVis', 'valVis', metar.vis >= 9999 ? '>10km' : (metar.vis + 'm'), metar.vis < 2000 ? 'warn' : '');

    // Status Banner
    const banner = document.getElementById('statusBanner');
    let isOk = metar.wind <= drone.wind && metar.gust <= drone.gust && (metar.temp >= drone.temp[0] && metar.temp <= drone.temp[1]);
    if (metar.rain && !drone.rain) isOk = false;

    banner.textContent = isOk ? "GO FOR FLIGHT" : "NO GO / CAUTION";
    banner.style.backgroundColor = isOk ? "rgba(34, 197, 94, 0.2)" : "rgba(239, 68, 68, 0.2)";
    banner.style.borderColor = isOk ? varName('--success') : varName('--danger');

    renderChart(forecast, drone.wind);
}

function setMetric(cardId, valId, val, state) {
    const card = document.getElementById(cardId);
    document.getElementById(valId).textContent = val;
    card.className = 'metric-card ' + state;
}

function varName(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }

/* ================= CHART (REAL FORECAST) ================= */
function renderChart(data, limit) {
    const ctx = document.getElementById('forecastChart').getContext('2d');
    const slices = data.list.slice(0, 9); // 24 hours (3h intervals)
    
    const labels = slices.map(s => new Date(s.dt * 1000).getHours() + ":00");
    const winds = slices.map(s => s.wind.speed);
    const gusts = slices.map(s => s.wind.gust || s.wind.speed * 1.2); // Если в OWM нет порывов, симулируем +20%

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Ветер (м/с)',
                    data: winds,
                    borderColor: '#38bdf8',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(56, 189, 248, 0.1)'
                },
                {
                    label: 'Порывы (м/с)',
                    data: gusts,
                    borderColor: '#f59e0b',
                    borderDash: [5, 5],
                    tension: 0.4
                },
                {
                    label: 'Лимит дрона',
                    data: new Array(9).fill(limit),
                    borderColor: '#ef4444',
                    borderWidth: 2,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#94a3b8' } } },
            scales: {
                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            }
        }
    });
}

function showToast(msg, type) {
    const container = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = 'toast';
    if (type === 'error') t.style.borderLeftColor = 'var(--danger)';
    if (type === 'success') t.style.borderLeftColor = 'var(--success)';
    t.textContent = msg;
    container.appendChild(t);
    setTimeout(() => t.remove(), 4000);
}
</script>

</body>
</html>
